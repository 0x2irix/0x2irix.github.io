---
import type { CollectionEntry } from "astro:content";
import path from "node:path";
import { Icon } from "astro-icon/components";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import { getDir } from "../utils/url-utils";
import ImageWrapper from "./misc/ImageWrapper.astro";
import PostMetadata from "./PostMeta.astro";

interface Props {
  class?: string;
  entry: CollectionEntry<"posts">;
  title: string;
  url: string;
  published: Date;
  updated?: Date;
  tags: string[];
  category: string | null;
  image: string;
  description: string;
  draft: boolean;
  style: string;
}

const {
  entry,
  title,
  url,
  published,
  updated,
  tags,
  category,
  image,
  description,
  style,
} = Astro.props;

const className = Astro.props.class ?? "";
const hasCover = image && image !== "";
const coverWidth = "32%"; // زودناه شوية عشان الصورة تبقى أوضح
const { remarkPluginFrontmatter } = await entry.render();
---

<div class:list={["card-base flex flex-col-reverse md:flex-col w-full rounded-[var(--radius-large)] overflow-hidden relative", className]} style={style}>
  <!-- النص -->
  <div class="pl-6 md:pl-9 pr-6 md:pr-2 pt-6 md:pt-7 pb-6 md:pb-8 flex flex-col flex-1 md:w-[calc(100%_-_var(--coverWidth)_-_20px)]">
    <a href={url} class="block font-bold text-3xl mb-4 text-[var(--primary)]">
      {title}
      <Icon class="inline text-2xl text-[var(--primary)] md:hidden ml-2" name="material-symbols:chevron-right-rounded" />
      <Icon class="hidden md:inline text-2xl text-[var(--primary)] opacity-0 group-hover:opacity-100 transition absolute -right-8" name="material-symbols:chevron-right-rounded" />
    </a>

    <!-- المحتوى كله جوا flex عشان الـ word count يفضل تحت -->
    <div class="flex flex-col flex-1">
      <div class="space-y-5">
        <PostMetadata published={published} updated={updated} tags={tags} category={category} hideTagsForMobile={false} hideUpdateDate={true} class="mb-4" />
        
        <p class="text-75 line-clamp-3 md:line-clamp-2 pr-4">
          {description || remarkPluginFrontmatter.excerpt}
        </p>
      </div>

      <!-- Word count + وقت القراءة دايماً تحت خالص -->
      <div class="mt-auto pt-6 text-sm text-black/30 dark:text-white/30 flex items-center gap-4">
        <span>{remarkPluginFrontmatter.words} {i18n(remarkPluginFrontmatter.words === 1 ? I18nKey.wordCount : I18nKey.wordsCount)}</span>
        <span class="text-black/20 dark:text-white/20">•</span>
        <span>{remarkPluginFrontmatter.minutes} {i18n(remarkPluginFrontmatter.minutes === 1 ? I18nKey.minuteCount : I18nKey.minutesCount)}</span>
      </div>
    </div>
  </div>

  <!-- الصورة - الحل السحري -->
  {hasCover && (
    <a 
      href={url}
      class="group relative md:absolute md:inset-y-4 md:right-4 md:w-[var(--coverWidth)] rounded-xl overflow-hidden shadow-2xl active:scale-95"
    >
      <!-- Overlay -->
      <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 transition z-10" />
      <div class="absolute inset-0 flex items-center justify-center z-20">
        <Icon name="material-symbols:chevron-right-rounded" class="text-white text-6xl scale-0 group-hover:scale-100 opacity-0 group-hover:opacity-100 transition" />
      </div>

      <!-- الصورة نفسها -->
      <ImageWrapper
        src={image}
        basePath={path.join("content/posts/", getDir(entry.id))}
        alt={title}
        class="w-full h-48 md:h-full object-cover md:object-contain bg-black/50"
      />
    </a>
  )}

  <!-- زرار الدخول لو مفيش صورة -->
  {!hasCover && (
    <a href={url} class="hidden md:flex absolute right-4 top-4 bottom-4 w-14 rounded-xl bg-[var(--enter-btn-bg)] hover:bg-[var(--enter-btn-bg-hover)] active:scale-95 items-center justify-center">
      <Icon name="material-symbols:chevron-right-rounded" class="text-4xl text-[var(--primary)]" />
    </a>
  )}
</div>

<!-- فاصل الموبايل -->
<div class="border-t border-dashed border-white/10 mx-6 my-6 md:hidden"></div>

<style define:vars={{ coverWidth }}>
  @media (min-width: 768px) {
    .object-contain { object-position: center; }
  }
</style>